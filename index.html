<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Costo Contenedor — Calculadora</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="Apple" sizes="180x180" href="./Apple.png?v=3.9">
  <meta name="theme-color" content="#0b7a75">
  <style>
    :root { --brand:#0b7a75; --ok:#e8f5e9; --bad:#fdecea; --muted:#6b7280; }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f7f7f7; color:#111; }
    header { background:var(--brand); color:white; padding:16px; position:sticky; top:0; }
    header h1 { margin:0; font-size:18px; }
    main { padding:12px; max-width:960px; margin:0 auto; }
    .card { background:white; border-radius:12px; padding:14px; margin-bottom:12px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); }
    .grid { display:grid; grid-template-columns: 1fr 180px; gap:10px 14px; align-items:center; }
    label { font-weight:700; font-size:15px; }
    .unit { color:var(--muted); font-size:12px; display:block; }
    input[type="number"], input[type="text"] { width:100%; padding:12px; font-size:18px; border:1px solid #d1d5db; border-radius:10px; }
    input:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 2px rgba(11,122,117,0.15); }
    .result-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #e5e7eb; }
    .result-row:last-child { border-bottom:none; }
    .res-label { font-weight:800; }
    .res-value { font-weight:900; font-size:20px; }
    .btns { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:0; font-weight:800; background:var(--brand); color:white; font-size:14px; }
    button.secondary { background:#eceff1; color:#111; }
    .hint { color:#374151; font-size:13px; }
    .warn { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:10px; margin-bottom:12px; display:none; }
    .footer { text-align:center; color:#6b7280; font-size:12px; padding:20px; }
    .subtle { color:#6b7280; font-size:12px; }
    h3 { margin-top:0; }
  </style>
</head>
<body>
  <header><h1>Calculadora — Costo por Contenedor</h1></header>
  <main>
    <div class="card">
      <div class="hint">Llena solo los números. Acepta coma o punto como decimal donde corresponda. Los datos se guardan en este teléfono.</div>
      <div class="btns">
        <button id="btnReset" class="secondary">Limpiar</button>
        <button id="btnShare" class="secondary">Compartir</button>
      </div>
      <div id="warn" class="warn"></div>
    </div>

    <div class="card">
      <h3>Entradas</h3>
      <div class="grid">
        <label>Tipo de cambio USD→EUR <span class="unit">EUR/US$</span></label>
        <input type="number" id="tc_usd_eur" step="any" min="0" inputmode="decimal" placeholder="Ej: 0,92">

        <label>Tipo de cambio EUR→CLP <span class="unit">CLP/EUR</span></label>
        <input type="number" id="tc_eur_clp" step="any" min="0" inputmode="decimal" placeholder="Ej: 950">

        <label>Tipo de cambio Peso Chileno→USD <span class="unit">CLP/US$</span></label>
        <input type="number" id="tc_clp_usd" step="any" min="0" inputmode="decimal" placeholder="Ej: 950">

        <label>Pallets por contenedor <span class="unit">pallets</span></label>
        <input type="number" id="pallets" step="1" min="0" inputmode="numeric" placeholder="Ej: 20">

        <label>Cajas por pallet <span class="unit">cajas/pallet</span></label>
        <input type="number" id="cajas_por_pallet" step="1" min="0" inputmode="numeric" placeholder="Ej: 80">

        <label>Kg por caja (packed) <span class="unit">kg/caja</span></label>
        <input type="text" id="kg_por_caja" inputmode="decimal" pattern="[0-9]+([\\.,][0-9]+)?" placeholder="Ej: 18 o 18,5">

        <label>Merma del campo al packing <span class="unit">%</span></label>
        <input type="text" id="merma_pct" inputmode="decimal" pattern="[0-9]+([\\.,][0-9]+)?" placeholder="Ej: 10 o 10,5">

        <label>Fruta <span class="unit">CLP/kg</span></label>
        <input type="number" id="fruta_kg" step="any" min="0" inputmode="decimal" placeholder="Ej: 350">

        <label>Packing <span class="unit">CLP/kg</span></label>
        <input type="number" id="packing_kg" step="any" min="0" inputmode="decimal" placeholder="Ej: 250">

        <label>Caja <span class="unit">CLP/caja</span></label>
        <input type="number" id="caja_x" step="any" min="0" inputmode="decimal" placeholder="Ej: 1600">

        <label>Pallet <span class="unit">CLP/pallet</span></label>
        <input type="number" id="pallet_unit" step="any" min="0" inputmode="decimal" placeholder="Ej: 300">

        <label>Huincha <span class="unit">CLP/pallet</span></label>
        <input type="number" id="huincha_pal" step="any" min="0" inputmode="decimal" placeholder="Ej: 200">

        <label>Esquineros <span class="unit">CLP/pallet</span></label>
        <input type="number" id="esquin_pal" step="any" min="0" inputmode="decimal" placeholder="Ej: 200">

        <label>Tapa <span class="unit">CLP/pallet</span></label>
        <input type="number" id="tapa_pal" step="any" min="0" inputmode="decimal" placeholder="Ej: 500">

        <label>Flete Campo→Packing <span class="unit">CLP/cont</span></label>
        <input type="number" id="flete_cp" step="any" min="0" inputmode="decimal" placeholder="Ej: 600000">

        <label>Flete Packing→Puerto <span class="unit">CLP/cont</span></label>
        <input type="number" id="flete_pp" step="any" min="0" inputmode="decimal" placeholder="Ej: 450000">

        <label>Flete Marítimo <span class="unit">US$/cont</span></label>
        <input type="number" id="flete_mar_usd" step="any" min="0" inputmode="decimal" placeholder="Ej: 5000">

        <label>Cobertura para precio mínimo garantizado <span class="unit">%</span></label>
        <input type="text" id="cobertura_pct" inputmode="decimal" pattern="[0-9]+([\\.,][0-9]+)?" placeholder="Ej: 10 o 15,5">
      </div>
      <div class="subtle">
        Fórmulas: Kg netos = Q×kg/caja; Kg brutos = Kg netos / (1 − merma); Fruta = Kg brutos×CLP/kg; Packing = Kg netos×CLP/kg;
        <strong>Pallet = pallet + huincha + esquineros + tapa</strong>;
        <strong>Kg descarte = Kg brutos − Kg netos</strong>;
        <strong>Precio mínimo garantizado = Costo TOTAL contenedor × (1 + cobertura)</strong>.
      </div>
    </div>

    <div class="card" id="resultCard">
      <h3>Resultados</h3>
      <div class="result-row"><span class="res-label">Cajas por contenedor (Q)</span><span class="res-value" id="r_q">—</span></div>
      <div class="result-row"><span class="res-label">Kg netos empacados</span><span class="res-value" id="r_kg_net">—</span></div>
      <div class="result-row"><span class="res-label">Kg brutos requeridos de fruta</span><span class="res-value" id="r_kg_bruto">—</span></div>
      <div class="result-row"><span class="res-label">Kg descarte</span><span class="res-value" id="r_kg_desc">—</span></div>

      <div class="result-row"><span class="res-label">Costo fruta (CLP)</span><span class="res-value" id="r_costo_fruta">—</span></div>
      <div class="result-row"><span class="res-label">Packing (CLP)</span><span class="res-value" id="r_costo_packing">—</span></div>
      <div class="result-row"><span class="res-label">Insumos caja (CLP)</span><span class="res-value" id="r_insumos_caja">—</span></div>
      <div class="result-row"><span class="res-label">Pallets (incl. tapa) (CLP)</span><span class="res-value" id="r_costo_pallets">—</span></div>
      <div class="result-row"><span class="res-label">Fletes internos (CLP)</span><span class="res-value" id="r_fletes_int">—</span></div>
      <div class="result-row"><span class="res-label">Flete marítimo (CLP)</span><span class="res-value" id="r_flete_mar">—</span></div>

      <div class="result-row"><span class="res-label">Costo TOTAL contenedor (CLP)</span><span class="res-value" id="r_total">—</span></div>
      <div class="result-row"><span class="res-label">Costo TOTAL contenedor cobertura (CLP)</span><span class="res-value" id="r_precio_min_garantizado">—</span></div>

      <div class="result-row"><span class="res-label">Costo por caja (CLP)</span><span class="res-value" id="r_cxcaja">—</span></div>
      <div class="result-row"><span class="res-label">Costo por caja cobertura (CLP)</span><span class="res-value" id="r_cxcaja_cov">—</span></div>

      <div class="result-row"><span class="res-label">Costo por kg (CLP)</span><span class="res-value" id="r_cxkg">—</span></div>
      <div class="result-row"><span class="res-label">Costo por kg cobertura (CLP)</span><span class="res-value" id="r_cxkg_cov">—</span></div>

      <div class="result-row"><span class="res-label">Costo TOTAL contenedor (EUR)</span><span class="res-value" id="r_total_eur">—</span></div>
      <div class="result-row"><span class="res-label">Costo TOTAL contenedor cobertura (EUR)</span><span class="res-value" id="r_precio_min_garantizado_eur">—</span></div>

      <div class="result-row"><span class="res-label">Costo por caja (EUR)</span><span class="res-value" id="r_cxcaja_eur">—</span></div>
      <div class="result-row"><span class="res-label">Costo por caja cobertura (EUR)</span><span class="res-value" id="r_cxcaja_cov_eur">—</span></div>

      <div class="result-row"><span class="res-label">Costo por kg (EUR)</span><span class="res-value" id="r_cxkg_eur">—</span></div>
      <div class="result-row"><span class="res-label">Costo por kg cobertura (EUR)</span><span class="res-value" id="r_cxkg_cov_eur">—</span></div>
    </div>

  </main>
  <div class="footer">Funciona offline. Tus datos no salen del dispositivo. — <strong>v3.10</strong></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const inputs = [
      'tc_usd_eur','tc_eur_clp','tc_clp_usd','pallets','cajas_por_pallet','kg_por_caja','merma_pct','fruta_kg','packing_kg','caja_x',
      'pallet_unit','huincha_pal','esquin_pal','tapa_pal','flete_cp','flete_pp','flete_mar_usd','cobertura_pct'
    ];
    const fmtCLP = (n) => isNaN(n) ? '—' : n.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0});
    const fmtEUR = (n) => isNaN(n) ? '—' : n.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:2});
    const fmtNum = (n, d=2) => isNaN(n) ? '—' : n.toLocaleString('es-CL', {maximumFractionDigits:d});

    function parseLocale(str) {
      if (typeof str !== 'string') return NaN;
      let s = str.trim();
      if (!s) return NaN;
      if (s.indexOf(',') >= 0 && s.indexOf('.') >= 0) {
        const lastComma = s.lastIndexOf(',');
        const lastDot = s.lastIndexOf('.');
        if (lastComma > lastDot) { s = s.replace(/\./g, '').replace(',', '.'); }
        else { s = s.replace(/,/g, ''); }
      } else if (s.indexOf(',') >= 0) {
        s = s.replace(',', '.');
      }
      return Number(s);
    }

    function read(name) {
      const el = $(name);
      const raw = el.value;
      const v = parseLocale(raw);
      return isNaN(v) ? 0 : v;
    }

    function compute() {
      const tc_usd_eur = read('tc_usd_eur');   // EUR / USD (por si luego lo necesitas)
      const tc_eur_clp = read('tc_eur_clp');   // CLP / EUR
      const tc_clp_usd = read('tc_clp_usd');   // CLP / US$

      // Tipo de cambio CLP por USD para flete marítimo:
      // prioridad: valor directo CLP/US$; si no hay, se deriva de USD→EUR y EUR→CLP
      let tc_usd_clp;
      if (tc_clp_usd > 0) {
        tc_usd_clp = tc_clp_usd;                  // CLP / US$
      } else if (tc_usd_eur > 0 && tc_eur_clp > 0) {
        tc_usd_clp = tc_usd_eur * tc_eur_clp;     // (EUR/US$)*(CLP/EUR) = CLP/US$
      } else {
        tc_usd_clp = NaN;
      }

      const pallets = read('pallets');
      const cajas_pallet = read('cajas_por_pallet');
      const kg_caja = read('kg_por_caja');
      const merma = read('merma_pct')/100;
      const fruta = read('fruta_kg');
      const packing = read('packing_kg');
      const caja = read('caja_x');
      const pallet_unit = read('pallet_unit');
      const huincha = read('huincha_pal');
      const esquineros = read('esquin_pal');
      const tapa = read('tapa_pal');
      const flete_cp = read('flete_cp');
      const flete_pp = read('flete_pp');
      const flete_mar_usd = read('flete_mar_usd');
      const cobertura = read('cobertura_pct')/100;

      const warn = (msg) => {
        const el = document.getElementById('warn');
        if (!msg) { el.style.display='none'; el.textContent=''; }
        else { el.style.display='block'; el.textContent = msg; }
      };
      let warnMsg = '';
      if (kg_caja <= 0 || pallets <= 0 || cajas_pallet <= 0) warnMsg = 'Completa pallets, cajas/pallet y kg/caja para calcular.';
      if (!(merma >= 0 && merma < 1)) warnMsg = 'La merma debe estar entre 0% y 100% (no 100%).';

      const Q = pallets * cajas_pallet;
      const kg_net = Q * kg_caja;
      const kg_bruto = (1 - merma) > 0 ? kg_net / (1 - merma) : NaN;
      const kg_desc = (!isNaN(kg_bruto) && !isNaN(kg_net) && kg_bruto >= kg_net) ? (kg_bruto - kg_net) : 0;

      const costo_fruta = isNaN(kg_bruto) ? NaN : kg_bruto * fruta;
      const costo_packing = kg_bruto * packing;
      const costo_insumos_caja = Q * caja;
      const costo_pallets = pallets * (pallet_unit + huincha + esquineros + tapa);
      const fletes_int = flete_cp + flete_pp;
      const flete_mar_clp = flete_mar_usd * tc_usd_clp;

      const total = [costo_fruta, costo_packing, costo_insumos_caja, costo_pallets, fletes_int, flete_mar_clp].some(isNaN)
        ? NaN
        : (costo_fruta + costo_packing + costo_insumos_caja + costo_pallets + fletes_int + flete_mar_clp);

      const precio_min_garantizado = (!isNaN(total)) ? total * (1 + cobertura) : NaN;

      const costo_xcaja = (Q>0 && !isNaN(total)) ? total / Q : NaN;
      const costo_xkg = (kg_net>0 && !isNaN(total)) ? total / kg_net : NaN;

      // Costo por caja/kg con cobertura (CLP)
      const costo_xcaja_cov = (Q>0 && !isNaN(precio_min_garantizado)) ? precio_min_garantizado / Q : NaN;
      const costo_xkg_cov = (kg_net>0 && !isNaN(precio_min_garantizado)) ? precio_min_garantizado / kg_net : NaN;

      // Conversión a EUR usando EUR→CLP (CLP / EUR): EUR = CLP / tc_eur_clp
      const total_eur = (!isNaN(total) && tc_eur_clp>0) ? total / tc_eur_clp : NaN;
      const precio_min_garantizado_eur = (!isNaN(precio_min_garantizado) && tc_eur_clp>0)
        ? precio_min_garantizado / tc_eur_clp : NaN;
      const costo_xcaja_eur = (!isNaN(costo_xcaja) && tc_eur_clp>0) ? costo_xcaja / tc_eur_clp : NaN;
      const costo_xkg_eur = (!isNaN(costo_xkg) && tc_eur_clp>0) ? costo_xkg / tc_eur_clp : NaN;

      const costo_xcaja_cov_eur = (!isNaN(costo_xcaja_cov) && tc_eur_clp>0) ? costo_xcaja_cov / tc_eur_clp : NaN;
      const costo_xkg_cov_eur = (!isNaN(costo_xkg_cov) && tc_eur_clp>0) ? costo_xkg_cov / tc_eur_clp : NaN;

      // Salidas CLP
      document.getElementById('r_q').textContent = isNaN(Q) ? '—' : fmtNum(Q,0);
      document.getElementById('r_kg_net').textContent = isNaN(kg_net) ? '—' : fmtNum(kg_net,0);
      document.getElementById('r_kg_bruto').textContent = isNaN(kg_bruto) ? '—' : fmtNum(kg_bruto,0);
      document.getElementById('r_kg_desc').textContent = isNaN(kg_desc) ? '—' : fmtNum(kg_desc,0);

      document.getElementById('r_costo_fruta').textContent = isNaN(costo_fruta) ? '—' : fmtCLP(costo_fruta);
      document.getElementById('r_costo_packing').textContent = isNaN(costo_packing) ? '—' : fmtCLP(costo_packing);
      document.getElementById('r_insumos_caja').textContent = isNaN(costo_insumos_caja) ? '—' : fmtCLP(costo_insumos_caja);
      document.getElementById('r_costo_pallets').textContent = isNaN(costo_pallets) ? '—' : fmtCLP(costo_pallets);
      document.getElementById('r_fletes_int').textContent = isNaN(fletes_int) ? '—' : fmtCLP(fletes_int);
      document.getElementById('r_flete_mar').textContent = isNaN(flete_mar_clp) ? '—' : fmtCLP(flete_mar_clp);

      document.getElementById('r_total').textContent = isNaN(total) ? '—' : fmtCLP(total);
      document.getElementById('r_precio_min_garantizado').textContent =
        isNaN(precio_min_garantizado) ? '—' : fmtCLP(precio_min_garantizado);

      document.getElementById('r_cxcaja').textContent = isNaN(costo_xcaja) ? '—' : fmtCLP(costo_xcaja);
      document.getElementById('r_cxcaja_cov').textContent = isNaN(costo_xcaja_cov) ? '—' : fmtCLP(costo_xcaja_cov);

      document.getElementById('r_cxkg').textContent = isNaN(costo_xkg) ? '—' : fmtNum(costo_xkg,0);
      document.getElementById('r_cxkg_cov').textContent = isNaN(costo_xkg_cov) ? '—' : fmtNum(costo_xkg_cov,0);

      // Salidas EUR
      document.getElementById('r_total_eur').textContent = isNaN(total_eur) ? '—' : fmtEUR(total_eur);
      document.getElementById('r_precio_min_garantizado_eur').textContent =
        isNaN(precio_min_garantizado_eur) ? '—' : fmtEUR(precio_min_garantizado_eur);

      document.getElementById('r_cxcaja_eur').textContent = isNaN(costo_xcaja_eur) ? '—' : fmtEUR(costo_xcaja_eur);
      document.getElementById('r_cxcaja_cov_eur').textContent =
        isNaN(costo_xcaja_cov_eur) ? '—' : fmtEUR(costo_xcaja_cov_eur);

      document.getElementById('r_cxkg_eur').textContent = isNaN(costo_xkg_eur) ? '—' : fmtNum(costo_xkg_eur,4);
      document.getElementById('r_cxkg_cov_eur').textContent =
        isNaN(costo_xkg_cov_eur) ? '—' : fmtNum(costo_xkg_cov_eur,4);

      const data = {}; inputs.forEach(n => data[n] = document.getElementById(n).value);
      localStorage.setItem('calcCont_v3_10', JSON.stringify(data));

      warn(warnMsg);
    }

    (function init(){
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=39');
      }
      const data = localStorage.getItem('calcCont_v3_10');
      if (data) {
        try {
          const o = JSON.parse(data);
          inputs.forEach(n => {
            if (o[n] !== undefined) document.getElementById(n).value = o[n];
          });
        } catch {}
      }
      inputs.forEach(id => document.getElementById(id).addEventListener('input', compute));
      document.getElementById('btnReset').addEventListener('click', () => {
        inputs.forEach(id => { document.getElementById(id).value=''; });
        compute();
      });
      document.getElementById('btnShare').addEventListener('click', async () => {
        const txt = document.getElementById('resultCard').innerText;
        if (navigator.share) {
          try { await navigator.share({title:'Costo Contenedor', text:txt}); } catch(e){}
        } else {
          alert('Compartir no disponible. Copia y pega los resultados.');
        }
      });
      compute();
    })();
  </script>
</body>
</html>
